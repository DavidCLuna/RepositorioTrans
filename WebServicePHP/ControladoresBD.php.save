<?php

require 'Database.php';

class Controlador
{
    function __construct()
    {
    }


/**
* Inicio Registros Cosecha
*/

//registro insumos abonadas

 public static function RegistroCosechaInsumosAbonadas(
        $lote, $tipoInsumo, $nombreInsumo, $cantidadInsumo, $unidadInsumo, $valorUnitarioInsumo, $valorTotalInsumos)
    {
        // Sentencia INSERT

        $comando = "call RegistroCosechaInsumosAbonada(?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $lote,
		$tipoInsumo,
		$nombreInsumo,
		$cantidadInsumo,
		$unidadInsumo,
		$valorUnitarioInsumo,
		$valorTotalInsumos)
        );
        }catch(PDOException $e){
                return null;
        }
}



//registro cosecha abonadas

 public static function RegistroCosechaAbonadas(
	$fecha,$lote,
	$nombreAbonada, 
	$cantidadManoObraAbonada, 
	$unidadManoObraAbonada,
	$costoUnitarioManoObraAbonada,
	$valorTotalManoObraAbonada,
	$cantidadTransporteAbonada,
	$unidadTransporteAbonada,
	$costoTransporteAbonada,
	$valorTotalTransporteAbonada,
	$valorTotalAbonada)
    {
        // Sentencia INSERT

        $comando = "call RegistroCosechaAbonada(?,?,?,?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,$lote,
        	$nombreAbonada, 
        	$cantidadManoObraAbonada, 
        	$unidadManoObraAbonada,
        	$costoUnitarioManoObraAbonada,
        	$valorTotalManoObraAbonada,
        	$cantidadTransporteAbonada,
        	$unidadTransporteAbonada,
        	$costoTransporteAbonada,
	        $valorTotalTransporteAbonada,
	        $valorTotalAbonada)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro cosecha siembra manual

 public static function RegistroCosechaSiembraManual(
        $fecha,$lote, $variedadSemilla, $cantidadBultos, 
	$precioBulto, $costoSemilla, $costoTransporte, $costoSecado, $pagoTotal, $valorTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroCosechaSiembraManual(?,?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
                $variedadSemilla,
		$cantidadBultos,
		$precioBulto,
		$costoSemilla,
		$costoTransporte,
		$costoSecado,
		$pagoTotal,
		$valorTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro cosecha siembra mecanizada

 public static function RegistroCosechaSiembraMecanizada(
        $fecha,$lote, $variedadSemilla, $costoSembradora, $costoSemilla, $secadoSemilla, $numHectareas, $costoManoObra, $cantidadBultos,
	$valorBulto, $transporteSemilla, $valorTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroCosechaSiembraMencanizada(?,?,?,?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
                $variedadSemilla,
                $costoSembradora,
                $costoSemilla,
                $secadoSemilla,
		$numHectareas,
		$costoManoObra,
		$cantidadBultos,
		$valorBulto,
		$transporteSemilla,
		$valorTotal
		)
        );
        }catch(PDOException $e){
                return null;
        }
}





/**
* Inicio Registros Preparacion de suelo
*/

//registro preparacion suelo preparacion suelo

 public static function RegistroPreparacionSueloPreparacionSuelo(
        $fecha,$lote,$tipo,$cantidad,
        $pases, $valor,$valorTotal, $valorTotalTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroPreparacionSuelo(?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
                $tipo,
                $cantidad,
		$pases,
                $valor,
                $valorTotal,	
		$valorTotalTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro preparacion suelo quema quimica mano de obra

 public static function RegistroPreparacionCortamaleza(
        $fecha,$lote,$tipo,$cantidad,
        $valor,$valorTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroCortamaleza(?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
                $tipo,
                $cantidad,
                $valor,
                $valorTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro preparacion suelo quema quimica mano de obra

 public static function RegistroPreparacionSueloQuemaQuimica(
	$fecha,$lote,$cantidadJornal,$valorUnidadJornal,
	$valorTotalJornal,$valorTotalTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroQuemaQuimica(?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
		$lote,
		$cantidadJornal,
		$valorUnidadJornal,
        	$valorTotalJornal,
		$valorTotalTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}

//registro preparacion suelo  quema fisica

 public static function RegistroPreparacionSueloQuemaFisica(
        $fecha,$lote,$cantidadJornal,$valorUnidadJornal,
        $valorTotalJornal,$cantidadInsu,$dosisInsu,
	$valorUnitarioInsu,$valorTotalInsu,$valorTotalTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroQuemaFisica(?,?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
                $cantidadJornal,
                $valorUnidadJornal,
                $valorTotalJornal,
		$cantidadInsu,
		$dosisInsu,
		$valorUnitarioInsu,
		$valorTotalInsu,
                $valorTotalTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro preparacion suelo  quema quimica

 public static function RegistroPreparacionSueloQuemaQuimicaInsumo(
        $lote, $tipo_insumo, $nombre_insumo, $cantidad_insumo, $unidad_insumo,
	$valor_unitario, $valor_total_insumo)
    {
        // Sentencia INSERT

        $comando = "call InsumosQuemaQuimica(?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{
        $sentencia = Database::getInstance()->getDb()->prepare($comando);
        return $sentencia->execute(
            array(
                $lote,	
		$tipo_insumo,
		$nombre_insumo,
		$cantidad_insumo,
		$unidad_insumo,
		$valor_unitario,
		$valor_total_insumo)
        );
        }catch(PDOException $e){
                return null;
        }
}

//registro preparacion suelo mantenimiento mano de obra

 public static function RegistroPreparacionSueloMantenimientoManoObra(
        $fecha,$lote,$tipo_limpieza,$cantidadJornal,$valorUnidadJornal,
        $valorTotalJornal,$valorTotalTotal)
    {
        // Sentencia INSERT

        $comando = "call RegistroMantenimiento(?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $fecha,
                $lote,
		$tipo_limpieza,
                $cantidadJornal,
                $valorUnidadJornal,
                $valorTotalJornal,
                $valorTotalTotal)
        );
        }catch(PDOException $e){
                return null;
        }
}

//registro preparacion suelo  mantenimiento insumos

 public static function RegistroPreparacionSueloMantenimientoInsumo(
        $lote, $tipo_insumo, $nombre_insumo, $cantidad_insumo, $unidad_insumo,
        $valor_unitario, $valor_total_insumo)
    {
        // Sentencia INSERT

        $comando = "call RegistroInsumosMantenimiento(?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $lote,
                $tipo_insumo,
                $nombre_insumo,
                $cantidad_insumo,
                $unidad_insumo,
                $valor_unitario,
                $valor_total_insumo)
        );
        }catch(PDOException $e){
                return null;
        }
}


//registro insumos

 public static function setInsumos(
        $nombre, $clasificacion)
    {
        // Sentencia INSERT

        $comando = "insert into nombres_insumos(nombre_insumo, clasificacion) values (?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $nombre,
		$clasificacion)
        );
        }catch(PDOException $e){
                return null;
        }
}



  //registro nuevo ciclo que se realiza concatenando la fecha actual con el numero de lote original

 public static function registroNewCicle(
        $lote)
    {
        // Sentencia INSERT

        $comando = "call new_cycle(?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $lote)
        );
        }catch(PDOException $e){
                return null;
        }
}


public static function getLoteNewCycle($lote)
    {
        // Consulta todos los costos  para mostrarlos en el principal activity m$
        $consulta = "select num_lote from lote where num_lote like ? order by num_lote desc limit 1";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($lote));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return null;
        }
    }


//registro token
public static function setDatosToken($token,$cedula)
    {
	//sentencia UPDATE
	$comando = "update notifitoken set token = ? where idusuario = ?";
	

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
		array($token,$cedula
		)
	);
        }catch(PDOException $e){
                return null;
        }
    }


//registro noticias
public static function setDatosNoticias(
	$image,$tipo,$descripcion)
    {
        // Sentencia INSERT
        $comando = "call registrarNoticia(?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $image,
		$tipo,
		$descripcion)
        );
        }catch(PDOException $e){
                return null;
        }
    }


/*Fin registros preparacion de suelo*/





public static function getDatosInsumos($clasificacion)
    {
        // Consulta todos los costos  para mostrarlos en el principal activity m$
        $consulta = "select * from nombres_insumos where clasificacion = ?";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($clasificacion));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
print($e);
            return null;
        }
    }


/*Método que consulta la informacion del arroz paddy*/

public static function getDatosPaddy()
    {
        // Consulta todos los costos  para mostrarlos en el principal activity menú costos
        $consulta = "select * from paddy";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array());
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }

/*Método que realiza la modificacion de los datos de la tabla paddy*/
public static function updateDatosPaddy(
        $asociados,$otros)
    {
        // Sentencia INSERT
        $comando = "update paddy set copasociados = ? , copotros = ?";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $asociados,
                $otros)
        );
        }catch(PDOException $e){
                return null;
        }
    }



public static function getDatosNoti()
    {
        // Consulta todos los costos  para mostrarlos en el principal activity menú costos
        $consulta = "select * from noticias";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($num_lote));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }


public static function getDatosNoticias($start, $limit){
	//consulta  las noticias que se encuentran almacenadas
	$consulta = "select * from noticias limit ?,?";
	try {
	    //preparar sentencia
	    $comando = Database::getInstance()->getDb()->prepare($consulta);
	    // Ejecutar sentencia preparada
	    $comando->execute();
	    // Capturar primera fila del resultado
	    $row = $comando->fecthAll(PDO::FETCH_ASSOC);
	    return $row;
	} catch (PDOException $e){
	    return -1;
	}
}

public static function getCountNoticias()
    {
        // Consulta cuantas noticias hay registradas
        $consulta = "select count(id) as numColum from noticias";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute();
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }
	

    public static function getDatosAlmacen()
    {
        // Consulta todos los almacenes para mostralos en el menú almacenes
        $consulta = "select * from almacenes";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute();
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }

/* metodo que realiza la consulta de las graficas*/   

public static function getDatosGraficas($lote)
    {
        // Consulta todos los almacenes para mostralos en el menú almacenes
        $consulta = "call graficas(?)";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(
			array($lote)
		);
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
}

/** metodo que consulta todas*/

public static function getDatosReporteDetallado($lote)
    {
        // Consulta todos los almacenes para mostralos en el menú almacenes
        $consulta = "call especificosapp(?)";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(
                        array($lote)
                );
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
}



/* obtener lotes para realizar la consulta de las graficas*/
public static function getDatosLotesGraficas($loteSin, $num_lote)
    {
        // Consulta todos los almacenes para mostralos en el menú almacenes
        $consulta = "select num_lote from lote where num_lote like ? and num_lote <= ? order by num_lote desc limit 3 ";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(
                        array($loteSin, $num_lote)
                );
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
}




public static function getDatosCostos($num_lote)
    {
        // Consulta todos los costos  para mostrarlos en el principal activity menú costos
        $consulta = "call arrayCostosapp(?)";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($num_lote));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }

    public static function getDatosLogin($usuario, $contrasena)
    {
        // Consulta que obtiene todos los datos del usuario para realizar el ingreso al sistema
        $consulta = "SELECT u.cedula,initcap(u.nombre) as nombre,initcap(u.apellido) as apellido ,u.contrasena,u.clave,u.sexo,u.telefono,u.correo,u.direccion,u.tipo,n.token  
		     FROM usuario u join notifitoken n on u.cedula = n.idusuario
                             WHERE cedula = ? and contrasena = ?";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($usuario, $contrasena));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }
/* funcion que realiza el login para la pagina administrativa que realiza registros de noticias y modificacion apddy*/
public static function getDatosLoginAdministrador($usuario, $contrasena)
    {
        // Consulta que obtiene todos los datos del usuario para realizar el ingreso al siste$
        $consulta = "SELECT * FROM usuario WHERE cedula = ? and contrasena = ? and tipo = 'Administrador'";
        try {
            // Preparar sentencia
            $comando = Database::getInstance()->getDb()->prepare($consulta);
            // Ejecutar sentencia preparada
            $comando->execute(array($usuario, $contrasena));
            // Capturar primera fila del resultado
            $row = $comando->fetchAll(PDO::FETCH_ASSOC);
            return $row;

        } catch (PDOException $e) {
            // Aqui puedes clasificar el error dependiendo de la excepcion
            // para presentarlo en la respuesta Json
            return -1;
        }
    }


    /*
     * Registrar usuario
     *
     * @param $cedula numero identificacion usuario primary key
     * @param $nombre  nombre del usuario
     * @param $apellido apellido de usuario
     * @param $contrasena contraseña del usuario con el que se loguea
     * @param $sexo sexo del usuario
     * @param $telefono numero de telefono del usuario
     * @param $correo correo del usuario tipo unique
     * @param $direccion direccion de la casa del usuario
     * @return PDOStatement
     */
    public static function registroUsuario(
        $cedula,
        $nombre,
	$apellido,
	$contrasena,
	$sexo,
	$telefono,
	$correo,
	$direccion,
	$token
    )
    {
        // Sentencia INSERT
        $consulta = "call insert_usuarioapp(?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
	try{
	
	$comando = Database::getInstance()->getDb()->prepare($consulta);
	//ejecutar sentencia prepaada
	$comando->execute(
            array(
	        $cedula,
	        $nombre,
	        $apellido,
		$correo,
		$contrasena,
        	$sexo,
	        $telefono,
	        $direccion,
		$token)
        );
	//capturar resultados
	$row = $comando->fetchAll(PDO::FETCH_ASSOC);
	return $row;
	}catch(PDOException $e){
		return null;
	}
    }


/*
public static function registroUsuario(
        $cedula,
        $nombre,
        $apellido,
        $contrasena,
        $sexo,
        $telefono,
        $correo,
        $direccion,
        $token
    )
    {
        // Sentencia INSERT
        $comando = "call insert_usuarioapp(?,?,?,?,?,?,?,?,?)";

        // Preparar la sentencia
        try{

        $sentencia = Database::getInstance()->getDb()->prepare($comando);

        return $sentencia->execute(
            array(
                $cedula,
                $nombre,
                $apellido,
                $correo,
                $contrasena,
                $sexo,
                $telefono,
                $direccion,
                $token)
        );
        }catch(PDOException $e){
                return null;
        }
    }

*/
    public static function getDatosLotes($cedula)
    {
	//consulta sql que lista todos los lotes del usuario con la cedula especificada
	$consulta = "SELECT num_lote FROM lote where usuario_cedula = ? order by num_lote desc";	

	try{
	    //preparar sentencia
	    $comando = Database::getInstance()->getDb()->prepare($consulta);
	    //ejecutar sentencia preparada
	    $comando->execute(array($cedula));
	    //capturar información
	    $row =  $comando->fetchAll(PDO::FETCH_ASSOC);
	    return $row;
	    
	} catch(PDOException $e){
	    return -1;
	}
    }


function calcularFechaPublicacion($get_timestamp)
{
        $timestamp = strtotime($get_timestamp);
        $diff = time() - (int)$timestamp;

        if ($diff == 0) 
             return 'justo ahora';

        if ($diff > 604800)
            return date("d M Y",$timestamp);

        $intervals = array
        (
            //1                   => array('año',    31556926),
           // $diff < 31556926    => array('mes',   2628000),
           // $diff < 2629744     => array('semana',    604800),
            $diff < 604800      => array('día',     86400),
            $diff < 86400       => array('hora',    3600),
            $diff < 3600        => array('minuto',  60),
            $diff < 60          => array('segundo',  1)
        );

        $value = floor($diff/$intervals[1][1]);
        return 'hace '.$value.' '.$intervals[1][0].($value > 1 ? 's' : '');
}
}
?>
